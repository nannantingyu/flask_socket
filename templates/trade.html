<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>交易系统</title>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <script src="{{ get_config('URL_PREFIX') }}static/bootstrap/js/bootstrap.js"></script>
    <script src="{{ get_config('URL_PREFIX') }}static/bootbox.min.js"></script>
    <link rel="stylesheet" href="{{ get_config('URL_PREFIX') }}static/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="{{ get_config('URL_PREFIX') }}static/bootstrap/css/bootstrap-theme.css">
    <link rel="stylesheet" href="{{ get_config('URL_PREFIX') }}static/style.css?2">
</head>
<body>
    <div class="container">
        <header class="navbar navbar-static-top bs-docs-nav" id="top">
            <div class="container">
                <div class="navbar-header">
                    <button class="navbar-toggle collapsed" type="button" data-toggle="collapse"
                            data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a href="/" class="navbar-brand">模拟交易系统</a>
                </div>
                <nav id="bs-navbar" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li>
                            <a href="{{ get_config('URL_PREFIX') }}trade">交易</a>
                        </li>
                        <li>
                            <a href="{{ get_config('URL_PREFIX') }}lists">我的资产</a>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        {% if session['user_id'] %}
                        <li>
                            <p class="navbar-text">欢迎你，{{ session['user_id'] }}</p>
                        </li>
                        <li>
                            <a href="{{ get_config('URL_PREFIX') }}logout">退出</a>
                        </li>
                        {% else %}
                        <li><a href="{{ get_config('URL_PREFIX') }}login">登录</a></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </header>

        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <ul class="list-group">
                        <li class="list-group-item">
                            品种：AGT+D
                        </li>
                        <li class="list-group-item">
                            当前价格：<span id="price_AGT_D"></span>
                        </li>
                        <li class="list-group-item">
                            最高价：<span id="high_AGT_D"></span>
                        </li>
                        <li class="list-group-item">
                            最低价：<span id="low_AGT_D"></span>
                        </li>
                        <li class="list-group-item">
                            成交量：<span id="volume_AGT_D"></span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <ul class="list-group">
                        <li class="list-group-item">
                            品种：AUT+D
                        </li>
                        <li class="list-group-item">
                            当前价格：<span id="price_AUT_D"></span>
                        </li>
                        <li class="list-group-item">
                            最高价：<span id="high_AUT_D"></span>
                        </li>
                        <li class="list-group-item">
                            最低价：<span id="low_AUT_D"></span>
                        </li>
                        <li class="list-group-item">
                            成交量：<span id="volume_AUT_D"></span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <ul class="list-group">
                        <li class="list-group-item">
                            品种：MAUT+D
                        </li>
                        <li class="list-group-item">
                            当前价格：<span id="price_MAUT_D"></span>
                        </li>
                        <li class="list-group-item">
                            最高价：<span id="high_MAUT_D"></span>
                        </li>
                        <li class="list-group-item">
                            最低价：<span id="low_MAUT_D"></span>
                        </li>
                        <li class="list-group-item">
                            成交量：<span id="volume_MAUT_D"></span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <ul class="list-group">
                        <li class="list-group-item">
                            品种：LLG
                        </li>
                        <li class="list-group-item">
                            当前价格：<span id="price_LLG"></span>
                        </li>
                        <li class="list-group-item">
                            最高价：<span id="high_LLG"></span>
                        </li>
                        <li class="list-group-item">
                            最低价：<span id="low_LLG"></span>
                        </li>
                        <li class="list-group-item">
                            成交量：<span id="volume_LLG"></span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <hr>
        <form class="form-horizontal" action="{{ get_config('URL_PREFIX') }}order" method="post">
            <div class="form-group">
                <label class="col-sm-2 control-label">品种</label>
                <div class="col-sm-10">
                    <select name="symbolName" class="form-control">
                        <option value="AGT+D">AGT+D</option>
                        <option value="AUT+D">AUT+D</option>
                        <option value="MAUT+D">MAUT+D</option>
                        <option value="LLG">LLG</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">挂单价格</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" name="price" data-reg="^\d+(\.\d+)?$" data-error="挂单价格格式不正确">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">交易方向</label>
                <div class="col-sm-10">
                    <label class="checkbox-inline">
                        <input type="radio" name="bsFlag" value="1" checked> 做多
                    </label>
                    <label class="checkbox-inline">
                        <input type="radio" name="bsFlag" value="2"> 做空
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">操作</label>
                <div class="col-sm-10">
                    <label class="checkbox-inline">
                        <input type="radio" name="ocFlag" value="o" checked> 建仓
                    </label>
                    <label class="checkbox-inline">
                        <input type="radio" name="ocFlag" value="c"> 平仓
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">挂单数量</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" name="quantity" data-reg="^\d+(\.\d+)?$" data-error="挂单数量格式不正确">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="button" class="btn btn-default">挂单</button>
                </div>
            </div>
        </form>
    </div>
    <script src="{{ get_config('URL_PREFIX') }}static/socket.io.js"></script>
    <script src="{{ get_config('URL_PREFIX') }}static/highstock.js"></script>
    <script src="{{ get_config('URL_PREFIX') }}static/highcharts-zh_CN.js"></script>
    <script>
        $("button").click(function(){
            var pass = true;
            $("input").each(function(index, el){
                var reg = $(el).data("reg");
                if(reg && !new RegExp(reg).test($(el).val())) {
                    bootbox.alert($(el).data("error"));
                    pass = false;
                    return false;
                }
            });

            if(pass) {
                $.ajax({
                    url: "{{ get_config('URL_PREFIX') }}placeOrder",
                    type: "post",
                    data: {
                        symbolName: $.trim($("select[name='symbolName']").val()),
                        price: $.trim($("input[name='price']").val()),
                        bsFlag: $("input[name='bsFlag']:checked").val(),
                        ocFlag: $("input[name='ocFlag']:checked").val(),
                        quantity: $.trim($("input[name='quantity']").val()),
                        wxid: "{{ session['user_id'] }}"
                    },
                    success: function(data) {
                        if(data && data.success == 1) {
                            location.href = "/lists";
                        }
                        else {
                            bootbox.alert("挂单失败");
                        }
                    }
                })
            }
        });
    </script>
    <script>
        const socket = io('http://tdsocket.jujin8.com', {
            "transports":['websocket', 'polling']
        });

        for (let code of ["AGT+D", "AUT+D", "MAUT+D", "LLG"]) {
            socket.on('quotation_' + code, (data) => {
                $("#price_" + data.code.replace("+", "_")).text(data.last);
                $("#low_" + data.code.replace("+", "_")).text(data.sell);
                $("#high_" + data.code.replace("+", "_")).text(data.buy);
                $("#volume_" + data.code.replace("+", "_")).text(data.volume);
            });
        }
    </script>
</body>
</html>